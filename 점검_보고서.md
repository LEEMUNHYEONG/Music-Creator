# Music Creator 프로그램 세밀 점검 보고서

점검 일자: 2025년  
점검 범위: index.html, app.js, 데이터 흐름, 보안·오류 처리, UI/UX

---

## 1. 전체 구조 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| **진입점** | ✅ | index.html → app.js 로드 |
| **단계 흐름** | ✅ | 1~6단계 (가사 작성 → 수노 변환 → AI 분석 → 개선안 → 최종 출력 → 마케팅) |
| **저장소** | ✅ | localStorage (musicCreatorProjects 등) |
| **API** | ✅ | Gemini, OpenAI 키 localStorage 저장 |

---

## 2. 확인된 사항 (정상)

- **escapeHtml**: app.js 3996행에 정의되어 있으며, 피드백·썸네일·분석 결과 등 사용자/API 텍스트 출력 시 XSS 방지에 사용됨.
- **displayImprovements**: app.js 4079행에 전역 함수로 정의, goToStep(4)에서 정상 호출.
- **수정 모드 / 읽기 전용**: toggleEditMode, updateEditModeUI, setReadOnlyMode 연동 정상.
- **프로젝트 저장/로드**: saveCurrentProject의 data 구조와 loadProject의 복원 로직이 대체로 일치.
- **에러 처리**: handleAPIError, callAPIWithRetry로 재시도·사용자 메시지 처리.
- **데이터 검증**: validateProjectData, normalizeProjectData로 저장 전 검증.

---

## 3. 수정이 필요한 항목

### 3.1 loadProject – flat 저장 구조 호환 (currentProject.data 보장)

**문제**: 예전에 저장된 프로젝트가 `{ id, title, originalLyrics, ... }` 처럼 **flat** 구조일 수 있음.  
이 경우 `window.currentProject.data`가 없어서 `restoreStepData`, `goToStep` 내부에서 `window.currentProject.data`를 쓰는 부분이 동작하지 않음.

**조치**: 로드 직후 `projectData = foundProject.data || foundProject`로 읽은 뒤,  
`window.currentProject.data`가 없으면 `window.currentProject.data = projectData` 로 한 번 보정.

---

### 3.2 MV 씬 복원 시 중복 ID (copySceneOverviewBtn_${index})

**문제**: loadProject에서 MV 씬 UI를 만들 때, 같은 씬 블록 안에 `id="copySceneOverviewBtn_${index}"` 가 두 번 사용됨  
(헤더 버튼 + “영어 프롬프트” 라벨 옆 버튼). HTML에서 id는 문서 내 유일해야 함.

**조치**: 둘 중 하나의 id를 다르게 변경 (예: 라벨 옆 버튼은 `copySceneOverviewEnBtn_${index}`).

---

### 3.3 index.html – 테마 태그 중복 (“격려”)

**문제**: 1단계 AI 옵션의 테마 태그에 “격려”가 두 번 나옴 (라인 523, 541 부근).

**조치**: 중복된 “격려” 버튼 하나 제거 (표시/기능 통일).

---

## 4. 권장 개선 사항 (우선순위 낮음)

1. **escapeHtml 호출 일관성** ✅  
   - 씬 설명·프롬프트·가사 옵션 등 동적 HTML을 `escapeHtml()`로 통일 반영함.

2. **MV 인물 저장 필드** ✅  
   - saveCurrentProject에서 `characters`에 `gender`, `age`, `race`, `appearance` 모두 저장하도록 수정함. loadProject와 스키마 일치.

3. **index.html 인라인 스크립트** ✅  
   - index.html의 중복 saveCurrentProject 구현 제거. 프로젝트 저장은 app.js 한 곳에서만 구현됨.

4. **프로젝트 목록 로드** ✅  
   - loadProjectList 진입 시 디바운스(150ms) 적용. 연속 호출 시 마지막 호출만 실행.

---

## 5. 보안·환경 요약

- API 키는 localStorage에만 저장되고, 코드에 하드코딩되지 않음.
- 사용자/API 입력을 innerHTML에 넣는 구간은 escapeHtml로 이스케이프되어 있음.
- file:// 프로토콜에서는 manifest 로드를 건너뛰어 CORS 이슈를 피함.

---

## 6. 결론

- **치명적 오류**: 없음.  
- **수정 권장**:  
  - loadProject에서 flat 구조일 때 `currentProject.data` 보장 (3.1)  
  - MV 씬 복원 시 복사 버튼 id 중복 제거 (3.2)  
  - 테마 태그 “격려” 중복 제거 (3.3)  

위 3가지를 반영하면 데이터 복원과 HTML 유효성, UI 일관성이 개선됩니다.
